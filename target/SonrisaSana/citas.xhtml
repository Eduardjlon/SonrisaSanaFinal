<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="content">

        <h2>Agenda de Citas</h2>

        <!-- MENSAJES -->
        <h:form id="global">
            <p:growl id="msgs" showDetail="true" showSummary="true" globalOnly="true"/>
        </h:form>

        <!-- AGENDA -->
        <h:form id="frmAgenda">

            <p:schedule id="agenda"
                        value="#{citaBean.eventModel}"
                        timeZone="America/Guatemala"
                        locale="es"
                        widgetVar="agendaWidget"
                        draggable="false"
                        resizable="false"
                        allDaySlot="false"
                        slotDuration="00:30"
                        view="agendaWeek"
                        minHour="7"
                        maxHour="20">

                <p:ajax event="dateSelect"
                        listener="#{citaBean.onDateSelect}"
                        update=":dlgCita"
                        oncomplete="PF('dlgCita').show();"/>

                <p:ajax event="eventSelect"
                        listener="#{citaBean.onEventSelect}"
                        update=":dlgCita"
                        oncomplete="PF('dlgCita').show();"/>

            </p:schedule>

        </h:form>

        <!-- DIALOGO CITA -->
        <p:dialog id="dlgCita"
                  header="Detalle de Cita"
                  widgetVar="dlgCita"
                  modal="true"
                  resizable="false"
                  width="500">

            <h:form id="frmCita">

                <p:panelGrid columns="1" layout="grid" style="width:100%" cellpadding="6">

                    <!-- PACIENTE -->
                    <p:outputLabel value="Paciente"/>

                    <p:selectOneMenu value="#{citaBean.pacienteId}"
                                     style="width:100%"
                                     rendered="#{not loginBean.odontologo}">
                        <f:selectItem itemLabel="Seleccione..." noSelectionOption="true"/>
                        <f:selectItems value="#{citaBean.pacientes}" var="p"
                                       itemLabel="#{p.nombreCompleto}" itemValue="#{p.id}"/>
                    </p:selectOneMenu>

                    <h:outputText value="#{citaBean.cita.paciente.nombreCompleto}"
                                  rendered="#{loginBean.odontologo}" />

                    <!-- ODONTOLOGO -->
                    <p:outputLabel value="Odontólogo"/>

                    <p:selectOneMenu value="#{citaBean.odontologoId}"
                                     style="width:100%"
                                     rendered="#{not loginBean.odontologo}">
                        <f:selectItem itemLabel="Seleccione..." noSelectionOption="true"/>
                        <f:selectItems value="#{citaBean.odontologos}" var="o"
                                       itemLabel="#{o.nombreCompleto}" itemValue="#{o.id}"/>
                    </p:selectOneMenu>

                    <h:outputText value="#{citaBean.cita.odontologo.nombreCompleto}"
                                  rendered="#{loginBean.odontologo}"/>

                    <!-- TRATAMIENTO -->
                    <p:outputLabel value="Tratamiento"/>

                    <p:selectOneMenu value="#{citaBean.tratamientoId}"
                                     style="width:100%"
                                     rendered="#{not loginBean.odontologo}">
                        <f:selectItem itemLabel="Seleccione..." noSelectionOption="true"/>
                        <f:selectItems value="#{citaBean.tratamientos}" var="t"
                                       itemLabel="#{t.nombre} (Q #{t.costo})"
                                       itemValue="#{t.id}"/>
                        <p:ajax event="change"
                                listener="#{citaBean.actualizarPrecios}"
                                update="precioBase precioTratamiento total"/>
                    </p:selectOneMenu>

                    <h:outputText value="#{citaBean.cita.tratamiento.nombre}"
                                  rendered="#{loginBean.odontologo}"/>

                    <!-- FECHA -->
                    <p:outputLabel value="Fecha y Hora"/>

                    <p:datePicker value="#{citaBean.cita.fechaInicio}"
                                  showTime="true"
                                  hourFormat="24"
                                  style="width:100%"
                                  rendered="#{not loginBean.odontologo}"/>

                    <h:outputText value="#{citaBean.cita.fechaInicio}"
                                  rendered="#{loginBean.odontologo}"/>

                    <!-- ESTADO -->
                    <p:outputLabel value="Estado"/>

                    <p:selectOneMenu value="#{citaBean.estadoNuevo}" style="width:100%">
                        <f:selectItem itemLabel="Seleccione..." noSelectionOption="true"/>
                        <f:selectItems value="#{citaBean.estadosDisponibles}" var="e"
                                       itemValue="#{e}" itemLabel="#{e}"/>
                    </p:selectOneMenu>

                    <!-- NOTAS -->
                    <p:outputLabel value="Notas"/>
                    <p:inputTextarea value="#{citaBean.cita.notas}"
                                     rows="3"
                                     autoResize="true"
                                     style="width:100%"
                                     disabled="#{loginBean.odontologo}"/>

                    <p:separator/>

                    <h3>Precios</h3>

                    <h:panelGrid columns="2" style="width:100%">

                        <h:outputText value="Precio base:"/>
                        <p:inputText id="precioBase"
                                     value="#{citaBean.cita.precioBase}"
                                     readonly="true"/>

                        <h:outputText value="Tratamiento:"/>
                        <p:inputText id="precioTratamiento"
                                     value="#{citaBean.cita.precioTratamiento}"
                                     readonly="true"/>

                        <h:outputText value="Total:"/>
                        <p:inputText id="total"
                                     value="#{citaBean.cita.total}"
                                     readonly="true"
                                     style="font-weight:bold;"/>
                    </h:panelGrid>

                </p:panelGrid>

                <!-- BOTONES -->
                <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:15px;">

                    <!-- ADMIN / RECEPCIÓN -->
                    <p:commandButton value="Guardar"
                                     rendered="#{not loginBean.odontologo}"
                                     styleClass="p-button-success"
                                     actionListener="#{citaBean.guardar}"
                                     update=":global:msgs :frmAgenda:agenda"
                                     oncomplete="PF('dlgCita').hide();"/>

                    <!-- ODONTÓLOGO SOLO GUARDA ESTADO -->
                    <p:commandButton value="Guardar Estado"
                                     rendered="#{loginBean.odontologo}"
                                     styleClass="p-button-success"
                                     actionListener="#{citaBean.guardarEstadoOdontologo}"
                                     update=":global:msgs :frmAgenda:agenda"
                                     oncomplete="PF('dlgCita').hide();"/>

                    <p:commandButton value="Cerrar"
                                     type="button"
                                     styleClass="p-button-secondary"
                                     onclick="PF('dlgCita').hide();"/>

                </div>

            </h:form>

        </p:dialog>

    </ui:define>

</ui:composition>
